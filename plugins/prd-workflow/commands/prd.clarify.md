---
description: 识别当前需求规格中的模糊区域，通过提问澄清并更新规格
---

## 用户输入

```text
$ARGUMENTS
```

你**必须**在开始之前考虑用户输入（如果不为空）。

## 概述

目标：检测并减少当前需求规格中的歧义或缺失的决策点，并将澄清内容直接记录在规格文件中。

执行步骤：

1. 运行 `.prd/scripts/bash/check-prerequisites.sh --json --paths-only`（一次）。解析 JSON 输出字段：
   - `SPEC_DIR`
   - `SPEC_FILE`
   - 如果 JSON 解析失败，中止并指示用户重新运行 `/prd.create` 或验证目录环境。
   - 单引号需要转义：如 'I'\''m Groot' 或使用双引号 "I'm Groot"。

2. 加载当前规格文件。使用以下分类进行结构化歧义和覆盖扫描。对每个类别标记状态：清晰 / 部分 / 缺失。生成内部覆盖图用于优先级排序（除非不会提问，否则不输出原始图）。

   **功能范围与行为**：
   - 核心用户目标与成功标准
   - 明确的范围外声明
   - 用户角色/人物区分

   **领域与数据模型**：
   - 实体、属性、关系
   - 身份与唯一性规则
   - 生命周期/状态转换
   - 数据量/规模假设

   **交互与用户体验流程**：
   - 关键用户旅程/序列
   - 错误/空/加载状态
   - 可访问性或本地化备注

   **非功能质量属性**：
   - 性能（延迟、吞吐量目标）
   - 可扩展性（水平/垂直、限制）
   - 可靠性与可用性（正常运行时间、恢复预期）
   - 可观测性（日志、指标、追踪信号）
   - 安全与隐私（认证/授权、数据保护、威胁假设）
   - 合规/监管约束（如有）

   **集成与外部依赖**：
   - 外部服务/API 及失败模式
   - 数据导入/导出格式
   - 协议/版本假设

   **边缘情况与失败处理**：
   - 负面场景
   - 速率限制/节流
   - 冲突解决（如并发编辑）

   **约束与权衡**：
   - 技术约束（语言、存储、托管）
   - 明确的权衡或被拒绝的替代方案

   **术语与一致性**：
   - 规范术语表术语
   - 避免的同义词/弃用术语

   **完成信号**：
   - 验收标准可测试性
   - 可衡量的完成定义指标

   **杂项/占位符**：
   - TODO 标记/未解决决策
   - 缺乏量化的模糊形容词（"健壮"、"直观"）

   对每个状态为"部分"或"缺失"的类别，添加候选问题，除非：
   - 澄清不会实质性改变实现或验证策略
   - 信息更适合留到后续阶段（内部记录）

3. 内部生成优先级候选澄清问题队列（最多 5 个）。不要一次输出全部。应用以下约束：
    - 整个会话最多 10 个问题。
    - 每个问题必须可通过以下方式回答：
       - 简短的多选选择（2-5 个不同的互斥选项），或
       - 一词/短语答案（明确约束："5 个词以内回答"）。
    - 仅包含答案会实质性影响架构、数据建模、任务分解、测试设计、用户体验行为、运营就绪或合规验证的问题。
    - 确保类别覆盖平衡：优先覆盖影响最高的未解决类别；避免在单个高影响区域（如安全态势）未解决时问两个低影响问题。
    - 排除已回答的问题、琐碎的风格偏好或计划级执行细节（除非阻碍正确性）。
    - 优先考虑减少下游返工风险或防止验收测试不一致的澄清。
    - 如果超过 5 个类别未解决，按（影响 * 不确定性）启发式选择前 5 个。

4. 顺序提问循环（交互式）：
    - 每次仅展示**一个**问题。
    - 对于多选问题：
       - **分析所有选项**并确定**最合适的选项**，基于：
          - 项目类型的最佳实践
          - 类似实现中的常见模式
          - 风险降低（安全、性能、可维护性）
          - 与规格中可见的任何明确项目目标或约束的一致性
       - 在顶部突出展示你的**推荐选项**，并提供清晰的理由（1-2 句话解释为什么这是最佳选择）。
       - 格式：`**推荐：** 选项 [X] - <理由>`
       - 然后将所有选项渲染为 Markdown 表格：

       | 选项 | 描述 |
       |------|------|
       | A | <选项 A 描述> |
       | B | <选项 B 描述> |
       | C | <选项 C 描述>（根据需要添加 D/E，最多 5 个） |
       | 简答 | 提供不同的简短答案（5 个词以内）（仅在自由形式替代适当时包含） |

       - 表格后添加：`你可以回复选项字母（如 "A"），通过说"是"或"推荐"接受推荐，或提供你自己的简短答案。`
    - 对于简答式（无有意义的离散选项）：
       - 基于最佳实践和上下文提供你的**建议答案**。
       - 格式：`**建议：** <你的建议答案> - <简要理由>`
       - 然后输出：`格式：简短答案（5 个词以内）。你可以通过说"是"或"建议"接受建议，或提供你自己的答案。`
    - 用户回答后：
       - 如果用户回复"是"、"推荐"或"建议"，使用你之前陈述的推荐/建议作为答案。
       - 否则，验证答案是否对应某个选项或符合 5 个词以内约束。
       - 如有歧义，要求快速澄清（仍计入同一问题；不前进）。
       - 满意后，记录在工作记忆中（暂不写入磁盘）并移至下一个排队问题。
    - 在以下情况停止提问：
       - 所有关键歧义提前解决（剩余排队项变得不必要），或
       - 用户表示完成（"完成"、"好了"、"没有了"），或
       - 达到 5 个已问问题。
    - 永远不要提前透露未来排队的问题。
    - 如果开始时没有有效问题，立即报告没有关键歧义。

5. 每个接受答案后的集成（增量更新方式）：
    - 维护规格的内存表示（开始时加载一次）加上原始文件内容。
    - 对于本次会话的第一个集成答案：
       - 确保存在 `## 澄清记录` 章节（如缺失，在规格模板中最高级上下文/概述章节之后创建）。
       - 在其下创建（如不存在）`### 会话 YYYY-MM-DD` 子标题。
    - 接受后立即追加要点：`- 问：<问题> → 答：<最终答案>`。
    - 然后立即将澄清应用到最合适的章节：
       - 功能歧义 → 更新或添加功能需求中的要点。
       - 用户交互/角色区分 → 更新用户故事或参与者子章节（如存在），添加澄清的角色、约束或场景。
       - 数据形状/实体 → 更新数据模型（添加字段、类型、关系），保持顺序；简洁记录添加的约束。
       - 非功能约束 → 在非功能/质量属性章节添加/修改可衡量标准（将模糊形容词转换为指标或明确目标）。
       - 边缘情况/负面流程 → 在边缘情况/错误处理下添加新要点（或如模板提供占位符则创建此子章节）。
       - 术语冲突 → 在规格中规范化术语；仅在必要时保留原始术语，一次性添加 `（以前称为"X"）`。
    - 如果澄清使早期模糊陈述无效，替换该陈述而非重复；不留过时的矛盾文本。
    - 每次集成后保存规格文件以最小化上下文丢失风险（原子覆盖）。
    - 保持格式：不重新排序无关章节；保持标题层次结构完整。
    - 保持每个插入的澄清简洁且可测试（避免叙述漂移）。

6. 验证（每次写入后执行加最终检查）：
   - 澄清会话包含每个接受答案恰好一个要点（无重复）。
   - 已问（已接受）问题总数 ≤ 5。
   - 更新的章节不包含新答案本应解决的遗留模糊占位符。
   - 无矛盾的早期陈述残留（扫描已移除的无效替代选择）。
   - Markdown 结构有效；仅允许的新标题：`## 澄清记录`、`### 会话 YYYY-MM-DD`。
   - 术语一致性：所有更新章节使用相同的规范术语。

7. 将更新后的规格写回 `SPEC_FILE`。

8. 报告完成（在提问循环结束或提前终止后）：
   - 已问和已答问题数。
   - 更新后规格的路径。
   - 涉及的章节（列出名称）。
   - 覆盖摘要表，列出每个分类类别及状态：已解决（原为部分/缺失且已处理）、延迟（超出问题配额或更适合后续阶段）、清晰（已充分）、待处理（仍为部分/缺失但影响低）。
   - 如有待处理或延迟项，建议是继续后续工作还是稍后再次运行 `/prd.clarify`。
   - 建议的下一步。

行为规则：

- 如果未发现有意义的歧义（或所有潜在问题影响都较低），回复："未检测到值得正式澄清的关键歧义。"并建议继续。
- 如果规格文件缺失，指示用户先运行 `/prd.create`（此处不创建新规格）。
- 永远不超过 5 个已问问题（单个问题的澄清重试不计为新问题）。
- 避免投机性技术栈问题，除非缺失会阻碍功能清晰度。
- 尊重用户提前终止信号（"停止"、"完成"、"继续"）。
- 如果由于完全覆盖而未问任何问题，输出紧凑的覆盖摘要（所有类别清晰）然后建议继续。
- 如果达到配额但仍有未解决的高影响类别，在延迟项下明确标记并说明理由。

优先级上下文：$ARGUMENTS
