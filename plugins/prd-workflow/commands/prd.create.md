---
description: 创建或更新需求规格文档
---

## 用户输入

```text
$ARGUMENTS
```

你**必须**在开始之前考虑用户输入（如果不为空）。

## 概述

用户在 `/prd.create` 后输入的文本就是需求描述。假设你始终可以在对话中获取它。如果 `$ARGUMENTS` 显示为字面值，不要让用户重复输入，除非他们提供的是空命令。

根据需求描述，执行以下步骤：

1. **生成简短名称**（2-4个词）用于目录命名：
   - 分析需求描述，提取最有意义的关键词
   - 创建2-4个词的短名称来概括需求
   - 使用动作-名词格式（如 "user-auth"、"payment-flow"）
   - 保留技术术语和缩写（OAuth2、API、JWT 等）
   - 保持简洁但足以理解需求
   - 示例：
     - "添加用户认证功能" → "user-auth"
     - "实现 OAuth2 集成" → "oauth2-integration"
     - "创建分析仪表板" → "analytics-dashboard"
     - "修复支付超时问题" → "fix-payment-timeout"

2. **查找下一个可用编号**：
   - 检查 `specs/` 目录中已存在的编号目录
   - 找到最高编号 N
   - 使用 N+1 作为新目录编号

3. **运行脚本创建目录结构**：
   ```bash
   .prd/scripts/bash/create-new-prd.sh --json "$ARGUMENTS" --number N+1 --short-name "your-short-name"
   ```

   **重要提示**：
   - 检查 specs/ 目录找到最高编号
   - 如果没有已存在的目录，从编号 1 开始
   - 此脚本每个需求只运行一次
   - JSON 输出包含 SPEC_DIR 和 SPEC_FILE 路径
   - 单引号需要转义：如 'I'\''m Groot' 或使用双引号 "I'm Groot"

4. 加载 `.prd/templates/spec-template.md` 理解必需章节。

5. 遵循以下执行流程：
   1. 从输入解析用户描述
      如果为空：ERROR "未提供需求描述"
   2. 从描述中提取关键概念
      识别：参与者、动作、数据、约束
   3. 对于不明确的方面：
      - 基于上下文和行业标准做出合理推断
      - 仅在以下情况标记 [待澄清: 具体问题]：
        - 选择对需求范围或用户体验有重大影响
        - 存在多种合理解释且含义不同
        - 不存在合理的默认值
      - **限制：最多 3 个 [待澄清] 标记**
      - 按影响优先级排序：范围 > 安全/隐私 > 用户体验 > 技术细节
   4. 填写用户场景与测试章节
      如果无法确定用户流程：ERROR "无法确定用户场景"
   5. 生成功能需求
      每个需求必须可测试
      对未指定的细节使用合理默认值（在假设章节记录）
   6. 定义成功标准
      创建可衡量的、与技术无关的成果
      包含定量指标（时间、性能、数量）和定性衡量（用户满意度、任务完成率）
      每个标准必须可验证且不涉及实现细节
   7. 识别关键实体（如涉及数据）
   8. 返回：SUCCESS（规格已准备好）

6. 使用模板结构将规格写入 SPEC_FILE，用从需求描述派生的具体细节替换占位符，同时保留章节顺序和标题。

7. **规格质量验证**：写完初始规格后，验证其是否符合质量标准：

   a. **创建规格质量检查清单**：在 `SPEC_DIR/checklists/requirements.md` 生成检查清单文件：

      ```markdown
      # 规格质量检查清单：[需求名称]

      **目的**：在交付前验证规格的完整性和质量
      **创建日期**：[日期]
      **需求**：[spec.md 链接]

      ## 内容质量

      - [ ] 无实现细节（语言、框架、API）
      - [ ] 聚焦于用户价值和业务需求
      - [ ] 为非技术相关方编写
      - [ ] 所有必填章节已完成

      ## 需求完整性

      - [ ] 无剩余 [待澄清] 标记
      - [ ] 需求可测试且无歧义
      - [ ] 成功标准可衡量
      - [ ] 成功标准与技术无关
      - [ ] 所有验收场景已定义
      - [ ] 已识别边缘情况
      - [ ] 范围已明确界定
      - [ ] 已识别依赖和假设

      ## 需求就绪度

      - [ ] 所有功能需求有明确的验收标准
      - [ ] 用户场景覆盖主要流程
      - [ ] 需求符合成功标准中定义的可衡量成果
      - [ ] 规格中无实现细节泄露

      ## 备注

      - 标记为未完成的项需要在交付前更新规格
      ```

   b. **运行验证检查**：对照每个检查项审查规格：
      - 对每个项判断是否通过
      - 记录发现的具体问题（引用相关规格章节）

   c. **处理验证结果**：

      - **如果所有项通过**：标记检查清单完成并进入第 8 步

      - **如果项未通过（不包括 [待澄清]）**：
        1. 列出失败项和具体问题
        2. 更新规格以解决每个问题
        3. 重新运行验证直到所有项通过（最多 3 次迭代）
        4. 如果 3 次后仍有失败，在检查清单备注中记录剩余问题并警告用户

      - **如果剩余 [待澄清] 标记**：
        1. 从规格中提取所有 [待澄清: ...] 标记
        2. **限制检查**：如果超过 3 个标记，仅保留最关键的 3 个（按范围/安全/用户体验影响），其余做出合理推断
        3. 对每个需要澄清的项（最多 3 个），以此格式向用户展示选项：

           ```markdown
           ## 问题 [N]：[主题]

           **上下文**：[引用相关规格章节]

           **需要了解**：[待澄清标记中的具体问题]

           **建议答案**：

           | 选项 | 答案 | 影响 |
           |------|------|------|
           | A    | [第一个建议答案] | [对需求的影响] |
           | B    | [第二个建议答案] | [对需求的影响] |
           | C    | [第三个建议答案] | [对需求的影响] |
           | 自定义 | 提供你的答案 | [解释如何提供自定义输入] |

           **你的选择**：_[等待用户回复]_
           ```

        4. **表格格式化**：确保 Markdown 表格正确格式化
        5. 按顺序编号问题（问题1、问题2、问题3 - 最多 3 个）
        6. 一次性展示所有问题后等待回复
        7. 等待用户回复所有问题的选择（如 "问题1: A, 问题2: 自定义 - [详情], 问题3: B"）
        8. 用用户选择或提供的答案替换每个 [待澄清] 标记更新规格
        9. 解决所有澄清后重新运行验证

   d. **更新检查清单**：每次验证迭代后，更新检查清单文件的通过/失败状态

8. 报告完成情况，包含目录名称、规格文件路径、检查清单结果，以及是否需要进一步澄清（`/prd.clarify`）。

**注意**：脚本创建目录结构并初始化规格文件。

## 通用指南

### 快速指南

- 聚焦于用户**需要什么**以及**为什么**。
- 避免描述如何实现（无技术栈、API、代码结构）。
- 为业务相关方而非开发者编写。
- 不要在规格中嵌入检查清单，那是单独的文件。

### 章节要求

- **必填章节**：每个需求必须完成
- **可选章节**：仅在与需求相关时包含
- 当某章节不适用时，完全删除它（不要留 "N/A"）

### AI 生成指南

从用户提示创建此规格时：

1. **做出合理推断**：使用上下文、行业标准和常见模式填补空白
2. **记录假设**：在假设章节记录合理的默认值
3. **限制澄清**：最多 3 个 [待澄清] 标记 - 仅用于以下关键决策：
   - 对需求范围或用户体验有重大影响
   - 有多种合理解释且含义不同
   - 缺乏任何合理默认值
4. **优先级排序**：范围 > 安全/隐私 > 用户体验 > 技术细节
5. **像测试者一样思考**：每个模糊需求都应无法通过"可测试且无歧义"检查
6. **常见需要澄清的领域**（仅在无合理默认值时）：
   - 需求范围和边界（包含/排除特定用例）
   - 用户类型和权限（如有多种冲突解释）
   - 安全/合规要求（法律/财务重要时）

**合理默认值示例**（不要询问这些）：
- 数据保留：领域的行业标准实践
- 性能目标：标准 Web/移动应用预期（除非另有说明）
- 错误处理：用户友好的消息和适当的回退
- 认证方式：Web 应用的标准会话或 OAuth2
- 集成模式：RESTful API（除非另有说明）

### 成功标准指南

成功标准必须：

1. **可衡量**：包含具体指标（时间、百分比、数量、比率）
2. **与技术无关**：不提及框架、语言、数据库或工具
3. **以用户为中心**：从用户/业务角度描述成果，而非系统内部
4. **可验证**：无需了解实现细节即可测试/验证

**好的示例**：
- "用户可在 3 分钟内完成结账"
- "系统支持 10,000 并发用户"
- "95% 的搜索在 1 秒内返回结果"
- "任务完成率提升 40%"

**不好的示例**（聚焦实现）：
- "API 响应时间低于 200ms"（太技术化，改用"用户立即看到结果"）
- "数据库可处理 1000 TPS"（实现细节，改用面向用户的指标）
- "React 组件渲染高效"（框架相关）
- "Redis 缓存命中率高于 80%"（技术相关）
